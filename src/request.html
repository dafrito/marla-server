<!DOCTYPE html>
<html>
<head>
<style>
table
{
border-collapse: collapse;
}
table td, table th
{
border: 1px solid grey;
}
</style>
<title>Request - Rainback</title>
<link rel=stylesheet type=text/css href="style.css">
</head>
<body>
<main class=content>
<h1>Requests</h1>
<h2>enum marla_RequestReadStage</h2>
Stages of reading a client request. Reads occur either from clients as original requests,
or from backends as returned responses. Consequently, there are two different sets of stages
for client and backend reading, though the enum is still marla_RequestReadStage.
<p>
<table>
<tr><th>Constant<th>Client parsing position
<tr><td>marla_CLIENT_REQUEST_READ_FRESH<td>Before or at client's HTTP request line.
<tr><td>marla_CLIENT_REQUEST_READING_METHOD<td>Client's HTTP method.
<tr><td>marla_CLIENT_REQUEST_PAST_METHOD<td>Client's whitespace after the HTTP method.
<tr><td>marla_CLIENT_REQUEST_READING_REQUEST_TARGET<td>Client's HTTP request target.
<tr><td>marla_CLIENT_REQUEST_PAST_REQUEST_TARGET<td>Client's whitespace after the HTTP request target.
<tr><td>marla_CLIENT_REQUEST_READING_VERSION<td>Client's HTTP version.
<tr><td>marla_CLIENT_REQUEST_READING_FIELD<td>Client's HTTP headers.
<tr><td>marla_CLIENT_REQUEST_AWAITING_CONTINUE_WRITE<td>After client's HTTP headers.
<tr><td>marla_CLIENT_REQUEST_AWAITING_UPGRADE_WRITE<td>After client's HTTP headers.
<tr><td>marla_CLIENT_REQUEST_READING_REQUEST_BODY<td>Client's HTTP request body.
<tr><td>marla_CLIENT_REQUEST_WEBSOCKET<td>Client's WebSocket connection.
<tr><td>marla_CLIENT_REQUEST_READING_CHUNK_SIZE<td>Client's HTTP request chunk header.
<tr><td>marla_CLIENT_REQUEST_READING_CHUNK_BODY<td>Client's HTTP request chunk body.
<tr><td>marla_CLIENT_REQUEST_READING_TRAILER<td>Client's HTTP request trailers.
<tr><td>marla_CLIENT_REQUEST_DONE_READING<td>After client's request.
</table>
<p>
Backend stages:
<p>
<table>
<tr><th>Constant<th>Backend parsing position
<tr><td>marla_BACKEND_REQUEST_FRESH<td>Before or at backend's response line.
<tr><td>marla_BACKEND_REQUEST_WRITTEN<td>Backend's HTTP response line.
<tr><td>marla_BACKEND_REQUEST_READING_HEADERS<td>Backend headers.
<tr><td>marla_BACKEND_REQUEST_AWAITING_RESPONSE<td>After backend's HTTP response headers.
<tr><td>marla_BACKEND_REQUEST_READING_RESPONSE_BODY<td>Backend's HTTP response body.
<tr><td>marla_BACKEND_REQUEST_READING_RESPONSE_TRAILER<td>Backend's HTTP response trailer.
<tr><td>marla_BACKEND_REQUEST_RESPONDING<td>After backend's HTTP response.
<tr><td>marla_BACKEND_REQUEST_DONE_READING<td>After backend's response.
</table>
<h2>enum marla_RequestWriteStage</h2>
<table>
<tr><th>Constant<th>Client write head position
<tr><td>marla_CLIENT_REQUEST_WRITE_AWAITING_ACCEPT<td>Nothing written
<tr><td>marla_CLIENT_REQUEST_WRITING_UPGRADE<td>Writing server's Upgrade response
<tr><td>marla_CLIENT_REQUEST_WRITING_CONTINUE<td>Writing server's 100 continue response.
<tr><td>marla_CLIENT_REQUEST_WRITING_RESPONSE<td>Writing server's HTTP response body.
<tr><td>marla_CLIENT_REQUEST_WRITING_WEBSOCKET_RESPONSE<td>Writing server's WebSocket response.
<tr><td>marla_CLIENT_REQUEST_DONE_WRITING<td>After server's HTTP response.
</table>
<h2>const char* marla_nameRequestReadStage(enum marla_RequestReadStage stage)</h2>
Returns a user-readable string naming the given read stage.
<h2>const char* marla_nameRequestWriteStage(enum marla_RequestWriteStage stage)</h2>
Returns a user-readable string naming the given write stage.
<h2>MIN_METHOD_LENGTH</h2>
The minimum tolerated length, in bytes, of a method.
<h2>MAX_METHOD_LENGTH</h2>
The maximum tolerated length, in bytes, of a method.
<h2>MAX_FIELD_NAME_LENGTH</h2>
The maximum tolerated length, in bytes, of a HTTP header name.
<h2>MAX_FIELD_VALUE_LENGTH</h2>
The maximum tolerated length, in bytes, of a HTTP header value.
<h2>MAX_WEBSOCKET_NONCE_LENGTH</h2>
The maximum length, in bytes, of a WebSocket nonce.
<h2>MAX_URI_LENGTH</h2>
The maxmimum length, in bytes, of a HTTP request target.
<h2>marla_MAX_CHUNK_SIZE</h2>
The maximum size of a single HTTP chunk body.
<h2>marla_MAX_CHUNK_SIZE_LINE</h2>
The maximum size of a single HTTP chunk header.
<h2>MAX_WEBSOCKET_CONTROL_PAYLOAD</h2>
The maximum size of a single HTTP chunk header.
<h2>marla_MESSAGE_IS_CHUNKED</h2>
Flag that indicates the HTTP response uses chunked transfer-coding.
<h2>marla_MESSAGE_LENGTH_UNKNOWN</h2>
Flag that indicates the HTTP response's length is not known.
<h2>marla_MESSAGE_USES_CLOSE</h2>
Flag that indicates the connection should be closed once the response is written.
<h2>enum marla_ClientEvent</h2>
<table>
<tr><th>Constant<th>Description<th>Meaning of data<th>Meaning of datalen
<tr><td>marla_BACKEND_EVENT_NEED_HEADERS<td>The backend request is ready for its request headers. Pointer to integer. Set to -1 if choked and set to 1 when headers are fully written (i.e. terminated by \r\n\r\n)<td>None<td>None
<tr><td>marla_BACKEND_EVENT_HEADER<td>Backend's HTTP header available to read. Name terminated by null.<td>HTTP header name and value.<td>Offset into HTTP header for reading header value.
<tr><td>marla_BACKEND_EVENT_MUST_READ<td>The backend request's response is ready for reading.<td>None<td>None
<tr><td>marla_BACKEND_EVENT_MUST_WRITE<td>The backend request's response is ready for writing.<td>None<td>None
<tr><td>marla_BACKEND_EVENT_NEED_TRAILERS<td>The backend request is now expecting trailer fields.<td>Pointer to integer. Set to nonzero when trailers are fully written (i.e terminated by \r\n\r\n)<td>None
<tr><td>marla_BACKEND_EVENT_CLIENT_PEER_CLOSED<td>The client request's connection was closed.<td>None<td>None
<tr><td>marla_BACKEND_EVENT_CLOSING<td>The backend request's connection is closing.<td>None<td>None
<tr><td>marla_EVENT_BACKEND_PEER_CLOSED<td>The backend request's connection was closed.<td>None<td>None
<tr><td>marla_EVENT_HEADER<td>HTTP header available to read. Name terminated by null.<td>HTTP header name and value.<td>Offset into HTTP header for reading header value.
<tr><td>marla_EVENT_ACCEPTING_REQUEST<td>Request headers read. Handler must accept request<td>Pointer to integer. If integer is set to nonzero, request is accepted.<td>None
<tr><td>marla_EVENT_REQUEST_BODY<td>HTTP request body ready.<td>None<td>None
<tr><td>marla_EVENT_FORM_FIELD
<tr><td>marla_EVENT_MUST_READ<td>Client data is available for reading<td>Pointer to integer. Set to nonzero if choked<td>None
<tr><td>marla_EVENT_MUST_WRITE<td>Client request is expecting a response.Set request's writeStage to marla_CLIENT_REQUEST_DONE_WRITING when done writing.<td>Pointer to integer. Set to nonzero if choked<td>None

<tr><td>marla_EVENT_WEBSOCKET_ESTABLISHED
<tr><td>marla_EVENT_WEBSOCKET_MUST_READ
<tr><td>marla_EVENT_WEBSOCKET_MUST_WRITE
<tr><td>marla_EVENT_WEBSOCKET_RESPOND
<tr><td>marla_EVENT_WEBSOCKET_CLOSING
<tr><td>marla_EVENT_WEBSOCKET_CLOSE_REASON
<tr><td>marla_EVENT_DESTROYING<td>The request is about to be freed<td>None<td>None
</table>
<h2>const char* marla_nameClientEvent(enum marla_ClientEvent ev)</h2>
Names the given client event.
<h2>struct marla_ClientRequest</h2>
<table>
<tr><th>Member<th>Description
<tr><td>struct marla_ClientRequest* next_request<td>The next request in line for this connection.
<tr><td>int id<td>A server-unique identifier for this request.
<tr><td>int statusCode<td>HTTP status code
<tr><td>char statusLine[MAX_FIELD_VALUE_LENGTH + 1]<td>HTTP status line text
<tr><td>struct marla_Connection* cxn<td>Underlying client connection
<tr><td>char method[MAX_METHOD_LENGTH + 1]<td>HTTP method
<tr><td>char host[MAX_FIELD_VALUE_LENGTH + 1]<td>HTTP host
<tr><td>char uri[MAX_URI_LENGTH + 1]<td>HTTP request target
<tr><td>char error[marla_BUFSIZE]<td>Error message
<tr><td>char contentType[MAX_FIELD_VALUE_LENGTH + 1]<td>Content-Type header value
<tr><td>int is_backend<td>Indicates if the client request is for a backend connection
<tr><td>enum marla_RequestReadStage readStage<td>Request's read stage
<tr><td>enum marla_RequestWriteStage writeStage<td>Request's write stage
<tr><td>int expect_upgrade<td>Indicates this request expects an upgrade to a different protocol.
<tr><td>int expect_continue<td>Indicates this request expects a 100 Continue response to be written.
<tr><td>int expect_trailer<td>Indicates this request expects HTTP trailer fields.
<tr><td>int expect_websocket<td>Indicates this request expected an upgrade to WebSocket.
<tr><td>int close_after_done<td>Indicates the connection will close once this request is complete.
<tr><td>void(*handle)(struct marla_ClientRequest*, enum marla_ClientEvent, void*, int)<td>Handles request events.
<tr><td>void* handleData<td>Internal data used for request events.
<tr><td>struct marla_ClientRequest* backendPeer<td>The other request being processed on account of this one.
<tr><td>long int contentLen<td>
<tr><td>long int totalContentLen<td>
<tr><td>long int chunkSize<td>
<tr><td>char websocket_nonce[MAX_WEBSOCKET_NONCE_LENGTH + 1]<td>
<tr><td>char websocket_accept[2 * SHA_DIGEST_LENGTH + 1]<td>
<tr><td>unsigned char websocket_frame[7]<td>
<tr><td>int websocket_pingLen<td>
<tr><td>unsigned char websocket_ping[MAX_WEBSOCKET_CONTROL_PAYLOAD]<td>
<tr><td>char websocket_pongLen<td>
<tr><td>unsigned char websocket_pong[MAX_WEBSOCKET_CONTROL_PAYLOAD]<td>
<tr><td>unsigned char websocket_closeReason[MAX_WEBSOCKET_CONTROL_PAYLOAD]<td>
<tr><td>char websocket_closeReasonLen<td>
<tr><td>int websocket_type<td>
<tr><td>int websocket_fin<td>
<tr><td>int needWebSocketClose<td>
<tr><td>int doingPong<td>
<tr><td>int doingWebSocketClose<td>
<tr><td>uint64_t websocketFrameWritten<td>
<tr><td>uint64_t websocketFrameOutLen<td>
<tr><td>uint64_t websocketFrameRead<td>
<tr><td>uint64_t websocketFrameLen<td>
<tr><td>char websocketOutMask[4]<td>
<tr><td>char websocketMask[4]<td>
<tr><td>int websocket_version<td>
</table>
<h2>marla_ClientRequest* marla_ClientRequest_new(struct marla_Connection* cxn, struct marla_Server* server)</h2>
<h2>void marla_ClientRequest_destroy(marla_ClientRequest*)</h2>
<h2>void marla_killClientRequest(struct marla_ClientRequest* req, const char* reason, ...)</h2>
</main>
<nav class=toc>
<h3>Requests</h3>
<ul>
<li>enum marla_RequestReadStage
<li>enum marla_RequestWriteStage
<li>const char* marla_nameRequestReadStage(enum marla_RequestReadStage stage)
<li>const char* marla_nameRequestWriteStage(enum marla_RequestWriteStage stage)
<li>MIN_METHOD_LENGTH
<li>MAX_METHOD_LENGTH
<li>MAX_FIELD_NAME_LENGTH
<li>MAX_FIELD_VALUE_LENGTH
<li>MAX_WEBSOCKET_NONCE_LENGTH
<li>MAX_URI_LENGTH
<li>marla_MAX_CHUNK_SIZE
<li>marla_MAX_CHUNK_SIZE_LINE
<li>MAX_WEBSOCKET_CONTROL_PAYLOAD
<li>marla_MESSAGE_IS_CHUNKED
<li>marla_MESSAGE_LENGTH_UNKNOWN
<li>marla_MESSAGE_USES_CLOSE
<li>enum marla_ClientEvent
<li>struct marla_ClientRequest
<li>marla_ClientRequest* marla_ClientRequest_new(struct marla_Connection* cxn, struct marla_Server* server)
<li>void marla_ClientRequest_destroy(marla_ClientRequest*)
<li>void marla_killClientRequest(struct marla_ClientRequest* req, const char* reason, ...)
</ul>
</nav>
</body>
</html>
